name: Test Dockerfile

on:
  pull_request:

jobs:
  list-files:
    runs-on: ubuntu-latest

    outputs:
      files: ${{ steps.list-files.outputs.files }}

    steps:
      - name: 🛎 Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: 📄 List Dockefile files
        id: list-files
        working-directory: ${{ github.workspace }}/dockerfiles
        run: |
          # git diff --name-only の結果をもとに、Dockerfile 拡張子のファイルを取得して、JSON配列として $GITHUB_OUTPUT に files として出力する
          echo "[$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E 'Dockerfile$' | sed -e 's/^/"/' -e 's/$/",/' | tr -d '\n' | sed -e 's/,$//')]"
          echo "files=[$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E 'Dockerfile$' | sed -e 's/^/"/' -e 's/$/",/' | tr -d '\n' | sed -e 's/,$//')]" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    needs: list-files

    strategy:
      matrix:
        file: ${{ fromJson(needs.list-files.outputs.files) }}

    steps:
      - name: 🛎 Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: 🧪 Test
        id: test
        run: |
          # dockerfiles/tests/<File>/ ディレクトリが存在するか確認し、存在する場合は、そのディレクトリに移動して docker build を実行する
          # <File> は拡張子を除いたファイル名
          filename=$(basename ${{ matrix.file }} .Dockerfile)
          if [ -d "${{ github.workspace }}/dockerfiles/tests/${filename}" ]; then
            cp ${{ github.workspace }}/${{ matrix.file }} ${{ github.workspace }}/dockerfiles/tests/${filename}/Dockerfile
            cd ${{ github.workspace }}/dockerfiles/tests/${filename}
            docker build -t test ${{ github.workspace }}

            echo "filename=${filename}" >> $GITHUB_OUTPUT
          else
            echo "filename=NULL" >> $GITHUB_OUTPUT
          fi

      - name: 📦 Upload artifact
        uses: actions/upload-artifact@v3
        if: steps.test.outputs.filename != 'NULL'
        with:
          name: ${{ steps.test.outputs.filename }}
          path: |
            dockerfiles/tests/${{ steps.test.outputs.filename }}/**
            !dockerfiles/tests/${{ steps.test.outputs.filename }}/node_modules
